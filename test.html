<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ระบบ WAIT → LOG</title>
<style>
  table, th, td { border: 1px solid #333; border-collapse: collapse; padding:5px; }
  th { background: #eee; }
  select { width: 120px; }
  button { margin: 2px; }
</style>
</head>
<body>
<h2>ข้อมูล WAIT</h2>
<button onclick="loadData()">รีเฟรช</button>
<div id="detail"></div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyuhgxopkMntJ_SY3DGZgDQYTFxnudR45XeiT6Foldbf_VeSRgGGA0ylLfvMx7vGRk/exec"; // ใส่ URL Web App ของคุณ

const addresses = ["501","502","503","401","401A","401B","401C","402","403","404","405","ห้องพักครู","301","302"];
const statuses  = ["ใช้งานได้","ชำรุด","เสื่อมสภาพ","หมดอายุการใช้งาน","ไม่รองรับการใช้งาน"];

function loadData(){
  const script = document.createElement('script');
  script.src = WEB_APP_URL + '?sheet=WAIT&callback=displayData';
  document.body.appendChild(script);
}

function displayData(rows){
  const container = document.getElementById('detail');
  if (!rows || rows.error) { container.innerHTML = "โหลดข้อมูลล้มเหลว"; return; }

  const tableRows = rows.map(r => `
    <tr>
      <td>${r.ID}</td>
      <td>${r.Name}</td>
      <td>
        <select onchange="r_address(this,'${r.ID}')">
          ${addresses.map(a=>`<option ${a==r.Address?'selected':''}>${a}</option>`).join('')}
        </select>
      </td>
      <td>
        <select onchange="r_status(this,'${r.ID}')">
          ${statuses.map(s=>`<option ${s==r.Status?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td>${r.Date}</td>
      <td>${r.Time}</td>
      <td>
        <button onclick="updateToLog('${r.ID}')">Update</button>
        <button onclick="deleteFromWait('${r.ID}')">Delete</button>
      </td>
    </tr>
  `).join('');

  container.innerHTML = `<table>
    <thead>
      <tr><th>ID</th><th>Name</th><th>ที่อยู่</th><th>สถานะ</th><th>วันที่</th><th>เวลา</th><th>Action</th></tr>
    </thead>
    <tbody>${tableRows}</tbody>
  </table>`;
}

// เก็บค่า select
let tempAddress = {}, tempStatus = {};
function r_address(sel,id){ tempAddress[id] = sel.value; }
function r_status(sel,id){ tempStatus[id] = sel.value; }

// อัปเดตกลับ LOG + ลบ WAIT
function updateToLog(id){
  const address = tempAddress[id] || '';
  const status  = tempStatus[id]  || '';

  fetch(WEB_APP_URL, {
    method:'POST',
    body: JSON.stringify({action:'updateToLog', ID:id, address, status})
  }).then(r=>r.json()).then(d=>{
    alert(d.status);
    loadData();
  });
}

// ลบ WAIT
function deleteFromWait(id){
  fetch(WEB_APP_URL, {
    method:'POST',
    body: JSON.stringify({action:'deleteFromWait', ID:id})
  }).then(r=>r.json()).then(d=>{
    alert(d.status);
    loadData();
  });
}

// โหลดตอนเปิด
loadData();
</script>
</body>
</html>

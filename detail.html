<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>รายละเอียดครุภัณฑ์</title>
  <link rel="stylesheet" href="detail.css">
  <style>
    body { font-family: "Prompt", sans-serif; background:#f4f6f8; margin:0; padding:20px; }
    header { display:flex; justify-content:space-between; align-items:center; background:#0a3d62; color:#fff; padding:12px 18px; border-radius:6px; }
    .detail-box { margin-top:18px; background:#fff; padding:18px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:8px 10px; border:1px solid #eee; text-align:left; font-size:14px; }
    th { background:#3c6382; color:#fff; }
    .notfound { color:#d00; }
  </style>
</head>
<body>
  <header>
    <div class="logo">logo</div>
    <h1>ระบบตรวจสอบครุภัณฑ์</h1>
    <div class="right"><a href="index.html" style="color:#fff;text-decoration:none;">กลับหน้าแรก</a></div>
  </header>

  <main>
    <div class="detail-box" id="detail">
      <h2>กำลังโหลดข้อมูล...</h2>
    </div>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    const sheetID = "1bkpz-iG4B8qnvZc4ql4qE15Qw8HrIZ1aeX1vZQzMFy0";
    const sheetName = "LOG";
    const baseURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;

    function pad(n){ return String(n).padStart(2,'0'); }

    function formatDateCell(val){
      if (!val) return "-";
      const m = String(val).match(/Date\(([^)]+)\)/);
      if (m) {
        const [y, mo, d] = m[1].split(',').map(Number);
        return `${pad(d)}/${pad(mo+1)}/${y}`;
      }
      const t = Date.parse(val);
      if (!isNaN(t)) {
        const d = new Date(t);
        return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
      }
      return val;
    }

    function formatTimeCell(val){
      if (!val) return "-";
      const m = String(val).match(/Date\(([^)]+)\)/);
      if (m) {
        const parts = m[1].split(',').map(Number);
        if (parts.length >= 6) return `${pad(parts[3])}:${pad(parts[4])}`;
      }
      const t = String(val).match(/(\d{1,2}):(\d{2})/);
      if (t) return `${pad(t[1])}:${pad(t[2])}`;
      return val;
    }

    function escapeHtml(str){
      if (str == null) return "";
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'", "&#39;");
    }

    async function loadDetail() {
      const container = document.getElementById("detail");
      if (!id) {
        container.innerHTML = `<div class="notfound">ไม่พบรหัสใน URL</div>`;
        return;
      }

      try {
        const res = await fetch(baseURL);
        const text = await res.text();
        const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\);/);
        if (!match) throw new Error("response ผิดรูปแบบ");

        const json = JSON.parse(match[1]);
        const rows = json.table.rows.map(r => (r.c||[]).map(c => c ? c.v : ""));

        // [0:รหัส,1:ชื่อ,2:ที่เก็บ,3:สถานะ,4:รายละเอียด,5:หมวด,6:วันที่,7:เวลา]
        const logs = rows.filter(r => String(r[0]) === String(id));

        if (logs.length === 0) {
          container.innerHTML = `<div class="notfound">ไม่พบข้อมูลครุภัณฑ์รหัส: <b>${id}</b></div>`;
          return;
        }

        const [code, name, , , , category] = logs[0];
        const tableRows = logs.map(r => `
          <tr>
            <td>${formatDateCell(r[6])}</td>
            <td>${formatTimeCell(r[7])}</td>
            <td>${escapeHtml(r[2])}</td>
            <td>${escapeHtml(r[3])}</td>
            <td>${escapeHtml(r[4])}</td>
            <td>${escapeHtml(r[5])}</td>
          </tr>`).join("");

        container.innerHTML = `
          <div class="asset-info">
            <p><strong>รหัสครุภัณฑ์:</strong> ${escapeHtml(code)}</p>
            <p><strong>ชื่อครุภัณฑ์:</strong> ${escapeHtml(name)}</p>
            <p><strong>หมวด:</strong> ${escapeHtml(category)}</p>
          </div>

          <div class="asset-table">
            <h3>ประวัติข้อมูล</h3>
            <table>
              <thead>
                <tr>
                  <th>วันที่</th>
                  <th>เวลา</th>
                  <th>ที่เก็บ</th>
                  <th>สถานะ</th>
                  <th>รายละเอียดเพิ่มเติม</th>
                  <th>หมวด</th>
                </tr>
              </thead>
              <tbody>${tableRows}</tbody>
            </table>
          </div>`;
      } catch (err) {
        console.error(err);
        container.innerHTML = `<div class="notfound">โหลดข้อมูลล้มเหลว: ${escapeHtml(err.message)}</div>`;
      }
    }

    loadDetail();
  </script>
</body>
</html>

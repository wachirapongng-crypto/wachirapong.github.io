<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบตรวจสอบครุภัณฑ์</title>
  <link rel="stylesheet" href="index.css" />
</head>
<body>
  <header>
    <h1>ระบบตรวจสอบครุภัณฑ์</h1>
  </header>

  <main>
    <table id="assetTable">
      <thead>
        <tr>
          <th>รหัส</th>
          <th>ชื่อครุภัณฑ์</th>
          <th>ที่เก็บ</th>
          <th>สถานะ</th>
          <th>เพิ่มเติม</th>
        </tr>
      </thead>
      <tbody id="assetBody"></tbody>
    </table>
  </main>

  <!-- modal แสดงหน้าเต็ม -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div id="modalBody">กำลังโหลดข้อมูล...</div>
    </div>
  </div>

  <script>
    const sheetID = "1bkpz-iG4B8qnvZc4ql4qE15Qw8HrIZ1aeX1vZQzMFy0";
    const sheetName = "LOG";
    const baseURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;

    // โหลดข้อมูลสรุป
    async function loadAssets() {
      const res = await fetch(baseURL);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const rows = json.table.rows.map(r => r.c.map(c => (c ? c.v : "")));

      const tbody = document.getElementById("assetBody");
      tbody.innerHTML = rows
        .map(r => `
          <tr>
            <td>${r[0]}</td>
            <td>${r[1]}</td>
            <td>${r[2]}</td>
            <td>${r[3]}</td>
            <td><button onclick="openFullDetail('${r[0]}')">ดูเพิ่มเติม</button></td>
          </tr>
        `)
        .join("");
    }

    // ย้ายฟังก์ชันหน้าเต็มมาอยู่ในนี้
    async function openFullDetail(id) {
      const modal = document.getElementById("detailModal");
      const modalBody = document.getElementById("modalBody");
      modal.style.display = "block";
      modalBody.innerHTML = "กำลังโหลดข้อมูล...";

      try {
        const res = await fetch(baseURL);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const rows = json.table.rows.map(r => r.c.map(c => (c ? c.v : "")));
        const logs = rows.filter(r => r[0] == id);

        if (logs.length > 0) {
          const first = logs[0];
          const tableRows = logs.map(r => `
            <tr>
              <td>${r[6] || "-"}</td>
              <td>${r[7] || "-"}</td>
              <td>${r[1] || "-"}</td>
              <td>${r[2] || "-"}</td>
              <td>${r[3] || "-"}</td>
              <td>${r[4] || "-"}</td>
              <td>${r[5] || "-"}</td>
            </tr>
          `).join("");

          modalBody.innerHTML = `
            <div class="asset-info">
              <p><strong>รหัส:</strong> ${first[0]}</p>
              <p><strong>ชื่อ:</strong> ${first[1]}</p>
              <p><strong>หมวด:</strong> ${first[5]}</p>
            </div>
            <table>
              <thead>
                <tr>
                  <th>วันที่</th>
                  <th>เวลา</th>
                  <th>ชื่อครุภัณฑ์</th>
                  <th>ที่เก็บ</th>
                  <th>สถานะ</th>
                  <th>รายละเอียดเพิ่มเติม</th>
                  <th>หมวด</th>
                </tr>
              </thead>
              <tbody>${tableRows}</tbody>
            </table>
          `;
        } else {
          modalBody.innerHTML = `<p>ไม่พบข้อมูลของรหัส ${id}</p>`;
        }
      } catch (err) {
        modalBody.innerHTML = `<p>เกิดข้อผิดพลาดในการโหลดข้อมูล</p>`;
        console.error(err);
      }
    }

    function closeModal() {
      document.getElementById("detailModal").style.display = "none";
    }

    loadAssets();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>รายการครุภัณฑ์ล่าสุด</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <header>
    <h2>รายการครุภัณฑ์ล่าสุด</h2>
    <a href="login.html" class="loginBtn">Login</a>
  </header>

  <div class="container">
    <table id="equipmentTable">
      <thead>
        <tr>
          <th>ลำดับ</th>
          <th>รหัส</th>
          <th>ชื่อ</th>
          <th>ที่เก็บ</th>
          <th>สถานะ</th>
          <th>รายละเอียด</th>
        </tr>
      </thead>
      <tbody>
        <!-- ข้อมูลจะถูกโหลดจาก Google Sheet -->
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <div id="modalDetails"></div>
    </div>
  </div>

  <script>
    const sheetID = "1bkpz-iG4B8qnvZc4ql4qE15Qw8HrIZ1aeX1vZQzMFy0";
    const sheetName = "SHOW"; // แท็บครุภัณฑ์
    const baseURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}&t=${Date.now()}`;

    const tableBody = document.querySelector("#equipmentTable tbody");
    const modal = document.getElementById("modal");
    const closeModal = document.getElementById("closeModal");
    const modalDetails = document.getElementById("modalDetails");

    async function loadEquipment() {
      try {
        const res = await fetch(baseURL);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        let data = json.table.rows.map(r => ({
          number: r.c[0]?.v,
          code: r.c[1]?.v,
          name: r.c[2]?.v,
          location: r.c[3]?.v,
          status: r.c[4]?.v,
          details: r.c[5]?.v
        }));

        // เรียงลำดับจากล่าสุดไปเก่าสุด
        data.sort((a, b) => b.number - a.number);

        tableBody.innerHTML = data.map(e => `
          <tr>
            <td>${e.number}</td>
            <td>${e.code}</td>
            <td>${e.name}</td>
            <td>${e.location}</td>
            <td>${e.status}</td>
            <td><button class="detailBtn">ดูรายละเอียด</button></td>
          </tr>
        `).join("");

        document.querySelectorAll(".detailBtn").forEach((btn, i) => {
          btn.addEventListener("click", () => {
            modalDetails.innerHTML = `
              <p><strong>${data[i].name} / ${data[i].code}</strong></p>
              <p>ที่เก็บ: ${data[i].location} | สถานะ: ${data[i].status}</p>
            `;
            modal.style.display = "block";
          });
        });

      } catch (error) {
        console.error("โหลดข้อมูลไม่สำเร็จ:", error);
      }
    }

    closeModal.onclick = () => modal.style.display = "none";
    window.onclick = e => { if(e.target == modal) modal.style.display = "none"; }

    loadEquipment();
  </script>
</body>
</html>

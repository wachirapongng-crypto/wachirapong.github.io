
document.addEventListener("DOMContentLoaded", () => {
document.getElementById("username").textContent = localStorage.getItem("username") || "Admin";

  const SHEET_URL = {
    DATA: "https://script.google.com/macros/s/AKfycbwDe2HZtpPi6aWVOGLpq5GbWv0YvgJpuK7VEVi9ZlkdXWDZl0Y-kOM8x6euvWq3F8IB/exec?sheet=DATA",
    WAIT: "https://script.google.com/macros/s/AKfycbwDe2HZtpPi6aWVOGLpq5GbWv0YvgJpuK7VEVi9ZlkdXWDZl0Y-kOM8x6euvWq3F8IB/exec?sheet=WAIT",
    SHOW: "https://script.google.com/macros/s/AKfycbwDe2HZtpPi6aWVOGLpq5GbWv0YvgJpuK7VEVi9ZlkdXWDZl0Y-kOM8x6euvWq3F8IB/exec?sheet=SHOW",
    LOGIN: "https://script.google.com/macros/s/AKfycbwDe2HZtpPi6aWVOGLpq5GbWv0YvgJpuK7VEVi9ZlkdXWDZl0Y-kOM8x6euvWq3F8IB/exec?sheet=LOGIN"
  };

  const formSection = document.getElementById("form-section");
  const formTitle = document.getElementById("form-title");
  const formContent = document.getElementById("form-content");
  const closeBtn = document.querySelector(".close-btn");
  const logoutBtn = document.getElementById("logout-btn");

  closeBtn.addEventListener("click", closeForm);
  formSection.addEventListener("click", e => { if(e.target===formSection) closeForm(); });
  logoutBtn.addEventListener("click", logout);

  window.openForm = async function(type){
    formSection.classList.add("show");
    formContent.innerHTML="";

    switch(type){
      case 'add':
        formTitle.textContent="‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå";
        formContent.innerHTML=`
          <label>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå:</label><input type="text" id="code">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå:</label><input type="text" id="name">
          <button onclick="saveData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>`;
        break;
      case 'edit':
        formTitle.textContent="‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå";
        await loadData('DATA',true);
        break;
      case 'wait':
        formTitle.textContent="üïì ‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö";
        await loadData('WAIT');
        break;
      case 'report':
        formTitle.textContent="üìä ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå";
        formContent.innerHTML=`
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ:</label>
          <input type="month" id="month">
          <button onclick="loadReport()">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
          <div id="report-result"></div>`;
        break;
      case 'list':
        formTitle.textContent="üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
        await loadData('DATA');
        break;
      case 'manual':
        formTitle.textContent="üìò ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
        formContent.innerHTML=`
          <p>1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå ‚Üí ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
          <p>2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>
          <p>3. ‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‚Üí ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô</p>
          <p>4. ‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
          <p>5. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö</p>`;
        break;
      case 'user':
        formTitle.textContent="üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
        await loadData('LOGIN');
        break;
    }
  }

  function closeForm(){ formSection.classList.remove("show"); }
  function logout(){ localStorage.removeItem("username"); window.location.href="login.html"; }

  window.loadData = async function(sheet,edit=false){
    try {
      const res = await fetch(SHEET_URL[sheet]);
      const data = await res.json();

      if(!Array.isArray(data)||data.length===0){ 
        formContent.innerHTML="<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>"; 
        return; 
      }

      let table="<table><tr>";
      Object.keys(data[0]).forEach(key=>table+=`<th>${key}</th>`);
      if(edit) table+="<th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>";
      table+="</tr>";

      data.forEach((row,i)=>{
        table+="<tr>";
        Object.values(row).forEach(val=>table+=`<td>${val}</td>`);
        if(edit) table+=`<td><button onclick="editItem(${i})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>`;
        table+="</tr>";
      });

      table+="</table>";
      formContent.innerHTML=table;

    } catch(err){
      console.error(err);
      formContent.innerHTML="<p style='color:red;'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡πÑ‡∏î‡πâ</p>";
    }
  }

  window.saveData = async function(){
    const code=document.getElementById("code").value.trim();
    const name=document.getElementById("name").value.trim();
    if(!code||!name){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }

    try {
      const res = await fetch(SHEET_URL.DATA,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({"‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå":code,"‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏∏‡∏†‡∏±‡∏ì‡∏ë‡πå":name})
      });
      const result = await res.json();
      if(result.status==="success"){
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        closeForm();
      }
    } catch(err){
      console.error(err);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
    }
  }

  window.editItem = function(index){ alert("‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà index: "+index+" ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"); }

  window.loadReport = async function(){
    const month=document.getElementById("month").value;
    if(!month){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"); return; }
    const reportDiv=document.getElementById("report-result");
    reportDiv.innerHTML="<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...</p>";

    try {
      const res = await fetch(SHEET_URL.SHOW+"&month="+month);
      const data = await res.json();
      if(!Array.isArray(data)||data.length===0){ reportDiv.innerHTML="<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>"; return; }

      let table="<table><tr>";
      Object.keys(data[0]).forEach(k=>table+=`<th>${k}</th>`);
      table+="</tr>";
      data.forEach(row=>{ table+="<tr>"+Object.values(row).map(v=>`<td>${v}</td>`).join("")+"</tr>"; });
      table+="</table>";
      reportDiv.innerHTML=table;
    } catch(err){
      console.error(err);
      reportDiv.innerHTML="<p style='color:red;'>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</p>";
    }
  }
});
